<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView-like Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        #chart {
            width: 100%;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .chevron {
            position: absolute;
            z-index: 10;
            width: 0;
            height: 0;
            border-style: solid;
        }
        .chevron-up {
            border-width: 0 10px 10px 10px;
            border-color: transparent transparent #eee transparent;
        }
        .chevron-down {
            border-width: 10px 10px 0 10px;
            border-color: #eee transparent transparent transparent;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="datetime">Jump to Datetime:</label>
        <input type="datetime-local" id="datetime">
        <button id="jump-btn">Jump</button>
    </div>
    <div id="chart"></div>
    <script>
        const chartContainer = document.getElementById('chart');

        // Initialize the chart
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                backgroundColor: '#FFFFFF',
                textColor: '#000',
            },
            grid: {
                vertLines: { color: '#eee' },
                horzLines: { color: '#eee' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const candlestickSeries = chart.addCandlestickSeries();

        // Fetch and set the data
        let chartData = [];
        fetch('eurusd15.json')
            .then(response => response.json())
            .then(data => {
                chartData = data.map(item => ({
                    time: new Date(item.datetime).getTime() / 1000,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                }));
                candlestickSeries.setData(chartData);
            })
            .catch(err => console.error('Error loading data:', err));

        // Dynamically resize the chart
        function resizeChart() {
            const viewportHeight = window.visualViewport?.height || window.innerHeight;
            const viewportWidth = window.visualViewport?.width || window.innerWidth;
            const controlsHeight = document.getElementById('controls').offsetHeight + 20; // Add padding

            // Resize the chart dynamically
            chartContainer.style.height = `${viewportHeight - controlsHeight}px`;
            chart.resize(viewportWidth - 20, viewportHeight - controlsHeight); // Leave 20px for price scale
        }

        window.addEventListener('resize', resizeChart);
        resizeChart();

        // Add chevrons above and below a specific candle
        function addChevronElements(time) {
            // Clear existing chevrons
            document.querySelectorAll('.chevron').forEach(chevron => chevron.remove());

            // Get the target candle
            const targetCandle = chartData.find(candle => candle.time === time);
            if (!targetCandle) return;

            // Calculate coordinates
            const x = Math.floor(chart.timeScale().timeToCoordinate(time));
            const y = Math.floor(chart.priceScale('right').priceToCoordinate(targetCandle.close));

            // Add chevron elements
            const chevronUp = document.createElement('div');
            chevronUp.className = 'chevron chevron-up';
            chevronUp.style.left = `${x - 10}px`; // Center the chevron
            chevronUp.style.top = `${y - 30}px`; // Position above the candle

            const chevronDown = document.createElement('div');
            chevronDown.className = 'chevron chevron-down';
            chevronDown.style.left = `${x - 10}px`; // Center the chevron
            chevronDown.style.top = `${y + 20}px`; // Position below the candle

            chartContainer.appendChild(chevronUp);
            chartContainer.appendChild(chevronDown);
        }

        // Jump to specific datetime
        document.getElementById('jump-btn').addEventListener('click', () => {
            const datetimeInput = document.getElementById('datetime').value;

            if (datetimeInput) {
                // Parse the datetime input as UTC
                const inputDate = new Date(datetimeInput);
                const targetTime = Math.floor(Date.UTC(
                    inputDate.getFullYear(),
                    inputDate.getMonth(),
                    inputDate.getDate(),
                    inputDate.getHours(),
                    inputDate.getMinutes()
                ) / 1000); // Convert to seconds

                // Find the closest data point
                const closestData = chartData.reduce((prev, curr) =>
                    Math.abs(curr.time - targetTime) < Math.abs(prev.time - targetTime) ? curr : prev
                );

                // Set the visible range around the target time
                if (closestData) {
                    chart.timeScale().setVisibleRange({
                        from: closestData.time - 60 * 15, // 15 minutes before
                        to: closestData.time + 60 * 15,  // 15 minutes after
                    });

                    // Add chevrons
                    addChevronElements(closestData.time);
                }
            } else {
                alert('Please select a valid datetime.');
            }
        });
    </script>
</body>
</html>
