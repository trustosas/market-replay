<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView-like Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        #chart {
            width: 100%;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div id="controls">
        <label for="datetime">Jump to:</label>
        <input type="datetime-local" id="datetime">
        <button id="jump-btn">Go</button>
    </div>
    <div id="chart"></div>
    <script>
        const chartContainer = document.getElementById('chart');
        
        // Initialize the chart
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                backgroundColor: '#FFFFFF',
                textColor: '#000',
            },
            grid: {
                vertLines: { color: '#eee' },
                horzLines: { color: '#eee' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
        });
        
        const candlestickSeries = chart.addCandlestickSeries();
        
        // Fetch and set the data
        let chartData = [];
        fetch('eurusd15.json')
            .then(response => response.json())
            .then(data => {
                chartData = data.map(item => ({
                    time: new Date(item.datetime).getTime() / 1000,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                }));
                candlestickSeries.setData(chartData);
            })
            .catch(err => console.error('Error loading data:', err));
        
        // Dynamically resize the chart
        function resizeChart() {
            const viewportHeight = window.visualViewport?.height || window.innerHeight;
            const viewportWidth = window.visualViewport?.width || window.innerWidth;
            const controlsHeight = document.getElementById('controls').offsetHeight + 20; // Add padding
        
            // Resize the chart dynamically
            chartContainer.style.height = `${viewportHeight - controlsHeight}px`;
            chart.resize(viewportWidth - 20, viewportHeight - controlsHeight); // Leave 20px for price scale
        }
        
        window.addEventListener('resize', resizeChart);
        resizeChart();
        
        // Crosshair snapping to high/low wicks
        chart.subscribeCrosshairMove((param) => {
            if (!param.point || !param.seriesData) return;
        
            const seriesData = param.seriesData.get(candlestickSeries);
            if (!seriesData) return;
        
            // Determine if the crosshair is closer to the high or low
            const { high, low } = seriesData;
            const snappedPrice = Math.abs(param.point.y - high) < Math.abs(param.point.y - low) ? high : low;
        
            // Update tooltip
            const tooltip = document.querySelector('.tooltip') || createTooltip();
            tooltip.style.left = `${param.point.x}px`;
            tooltip.style.top = `${chart.priceScale('right').priceToCoordinate(snappedPrice) - 15}px`; // Offset
            tooltip.innerHTML = `Snapped Price: ${snappedPrice.toFixed(2)}`;
        });
        
        // Helper function to create a tooltip
        function createTooltip() {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.style.position = 'absolute';
            tooltip.style.background = 'rgba(0, 0, 0, 0.8)';
            tooltip.style.color = '#fff';
            tooltip.style.padding = '5px';
            tooltip.style.borderRadius = '3px';
            tooltip.style.pointerEvents = 'none';
            document.body.appendChild(tooltip);
            return tooltip;
        }
    </script>
</body>

</html>