<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradingView-like Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        #chart {
            width: 100%;
        }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
        }
        .vertical-crosshair {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            width: 2px;
            height: 100%;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="datetime">Jump to Datetime:</label>
        <input type="datetime-local" id="datetime">
        <button id="jump-btn">Jump</button>
    </div>
    <div id="chart"></div>
    <script>
        const chartContainer = document.getElementById('chart');

        // Initialize the chart
        const chart = LightweightCharts.createChart(chartContainer, {
            layout: {
                backgroundColor: '#FFFFFF',
                textColor: '#000',
            },
            grid: {
                vertLines: { color: '#eee' },
                horzLines: { color: '#eee' },
            },
            timeScale: {
                timeVisible: true,
                secondsVisible: false,
            },
        });

        const candlestickSeries = chart.addCandlestickSeries();

        // Fetch and set the data
        let chartData = [];
        fetch('eurusd15.json')
            .then(response => response.json())
            .then(data => {
                chartData = data.map(item => ({
                    time: new Date(item.datetime).getTime() / 1000,
                    open: item.open,
                    high: item.high,
                    low: item.low,
                    close: item.close,
                }));
                candlestickSeries.setData(chartData);
            })
            .catch(err => console.error('Error loading data:', err));

        // Dynamically resize the chart
        function resizeChart() {
            const viewportHeight = window.visualViewport?.height || window.innerHeight;
            const viewportWidth = window.visualViewport?.width || window.innerWidth;
            const controlsHeight = document.getElementById('controls').offsetHeight + 20; // Add padding

            // Resize the chart dynamically
            chartContainer.style.height = `${viewportHeight - controlsHeight}px`;
            chart.resize(viewportWidth - 20, viewportHeight - controlsHeight); // Leave 20px for price scale
        }

        window.addEventListener('resize', resizeChart);
        resizeChart();

        // Add a vertical crosshair
        document.getElementById('jump-btn').addEventListener('click', () => {
            const datetimeInput = document.getElementById('datetime').value;

            if (datetimeInput) {
                // Parse the datetime input as UTC
                const inputDate = new Date(datetimeInput);
                const targetTime = Math.floor(Date.UTC(
                    inputDate.getFullYear(),
                    inputDate.getMonth(),
                    inputDate.getDate(),
                    inputDate.getHours(),
                    inputDate.getMinutes()
                ) / 1000); // Convert to seconds

                // Find the closest data point in UTC
                const closestData = chartData.reduce((prev, curr) =>
                    Math.abs(curr.time - targetTime) < Math.abs(prev.time - targetTime) ? curr : prev
                );

                // Draw the vertical crosshair
                if (closestData) {
                    drawVerticalCrosshair(closestData);
                }
            } else {
                alert('Please select a valid datetime.');
            }
        });

        function drawVerticalCrosshair(closestData) {
            // Remove any existing crosshair
            const existingCrosshair = document.querySelector('.vertical-crosshair');
            if (existingCrosshair) existingCrosshair.remove();

            // Get the X-coordinate of the closest data point
            const xCoordinate = chart.timeScale().timeToCoordinate(closestData.time);

            // If the coordinate is valid, draw the line
            if (xCoordinate !== null) {
                const verticalLine = document.createElement('div');
                verticalLine.className = 'vertical-crosshair';
                verticalLine.style.left = `${xCoordinate}px`;

                // Append to the chart container
                chartContainer.appendChild(verticalLine);
            }
        }
    </script>
</body>
</html>
